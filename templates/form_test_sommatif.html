<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Favicon VirtuEduc -->
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon/favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon/favicon-16x16.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='favicon/site.webmanifest') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon/favicon.ico') }}">
  <meta name="msapplication-TileColor" content="#4361ee">
  <meta name="theme-color" content="#4361ee">
  <title>{% if lang == 'en' %}Add Final Test{% else %}Ajouter un Test Sommatif{% endif %}</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #9b59b6;
      --primary-dark: #8e44ad;
      --secondary: #2c3e50;
      --secondary-dark: #1a252f;
      --accent: #3498db;
      --accent-dark: #2980b9;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --border-radius: 10px;
      --box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--dark);
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .lang-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      background: white;
      padding: 10px 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .lang-selector label {
      margin: 0;
      font-weight: 600;
    }

    .lang-selector select {
      border: 1px solid var(--light-gray);
      border-radius: 6px;
      padding: 8px 12px;
      background: white;
      cursor: pointer;
      transition: var(--transition);
    }

    .lang-selector select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(155, 89, 182, 0.2);
    }

    .form-box {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
      margin-bottom: 30px;
    }

    .form-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 25px 30px;
      text-align: center;
    }

    .form-header h2 {
      font-size: 1.8rem;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .form-header p {
      opacity: 0.9;
      font-size: 1rem;
    }

    .form-body {
      padding: 30px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--secondary);
    }

    .required::after {
      content: " *";
      color: #e74c3c;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--light-gray);
      border-radius: 8px;
      font-family: inherit;
      font-size: 1rem;
      transition: var(--transition);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(155, 89, 182, 0.2);
    }

    textarea {
      resize: vertical;
      white-space: pre-wrap;
      min-height: 100px;
    }

    .exercice-block {
      border: 1px solid var(--light-gray);
      padding: 25px;
      margin-top: 25px;
      border-radius: var(--border-radius);
      background: var(--light);
      position: relative;
      transition: var(--transition);
    }

    .exercice-block:hover {
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }

    .exercice-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--light-gray);
    }

    .exercice-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem;
      color: var(--primary);
    }

    .btn-remove {
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn-remove:hover {
      background: #c0392b;
    }

    .math-editor {
      width: 100%;
      min-height: 3.5em;
      border: 1px solid var(--light-gray);
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      font-family: inherit;
    }

    .btn-insert {
      margin-top: 10px;
      padding: 8px 15px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
    }

    .btn-insert:hover {
      background: var(--accent-dark);
    }

    .btn-add-exercice {
      width: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 15px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .btn-add-exercice:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 15px rgba(155, 89, 182, 0.4);
    }

    .submit-button {
      width: 100%;
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 15px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 30px;
    }

    .submit-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 15px rgba(46, 204, 113, 0.4);
    }

    .back-link {
      text-align: center;
      margin-top: 25px;
    }

    .back-link a {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--secondary);
      color: white;
      padding: 12px 25px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: var(--transition);
    }

    .back-link a:hover {
      background: var(--secondary-dark);
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.1);
    }

    .file-upload {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }

    .file-upload input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      background: var(--light-gray);
      border: 2px dashed var(--gray);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .file-upload-label:hover {
      background: #dfe6e9;
      border-color: var(--primary);
    }

    .file-upload-label i {
      font-size: 1.5rem;
      color: var(--primary);
    }

    .language-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--light-gray);
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      border-bottom: 3px solid transparent;
    }

    .tab.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .exercice-counter {
      text-align: center;
      margin: 15px 0;
      font-weight: 600;
      color: var(--primary);
      font-size: 1.1rem;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: var(--light-gray);
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .lang-selector {
        justify-content: center;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .form-body {
        padding: 20px;
      }
      
      .exercice-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      box-shadow: var(--box-shadow);
      z-index: 1000;
      transform: translateX(150%);
      transition: transform 0.4s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: #2ecc71;
    }

    .notification.error {
      background: #e74c3c;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive.core.css">
  <script defer src="https://unpkg.com/mathlive"></script>
</head>
<body>
  <div class="container">
    <!-- Header avec s√©lecteur de langue -->
    <div class="header">
      <div class="lang-selector">
        <label for="lang">üåç</label>
        <form method="POST" action="/changer-langue" id="langForm">
          <select name="lang" id="lang" onchange="document.getElementById('langForm').submit()">
            <option value="fr" {% if lang == 'fr' %}selected{% endif %}>üá´üá∑ Fran√ßais</option>
            <option value="en" {% if lang == 'en' %}selected{% endif %}>üá¨üáß English</option>
          </select>
          <input type="hidden" name="redirect_page" value="ajouter_test">
        </form>
      </div>
    </div>

    <!-- Formulaire principal -->
    <div class="form-box">
      <div class="form-header">
        <h2><i class="fas fa-vial"></i> {% if lang == 'en' %}Add Final Test{% else %}Ajouter un Test Sommatif{% endif %}</h2>
        <p>{% if lang == 'en' %}Create a comprehensive test for your students{% else %}Cr√©ez un test complet pour vos √©tudiants{% endif %}</p>
      </div>

      <div class="form-body">
        <form method="POST" enctype="multipart/form-data" id="testForm">
          <!-- Section Cat√©gorisation -->
          <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-folder-open"></i> {% if lang == 'en' %}Categorization{% else %}Cat√©gorisation{% endif %}</h3>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="niveau" class="required">{% if lang == 'en' %}Level{% else %}Niveau{% endif %} :</label>
                <select id="niveau" name="niveau_id" required>
                  <option value="">{% if lang == 'en' %}-- Choose level --{% else %}-- Choisir un niveau --{% endif %}</option>
                  {% for niveau in niveaux %}
                    <option value="{{ niveau.id }}">{{ niveau.nom_en if lang == 'en' and niveau.nom_en else niveau.nom }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group">
                <label for="matiere" class="required">{% if lang == 'en' %}Subject{% else %}Mati√®re{% endif %} :</label>
                <select id="matiere" name="matiere_id" required disabled>
                  <option value="">{% if lang == 'en' %}-- Choose subject --{% else %}-- Choisir une mati√®re --{% endif %}</option>
                </select>
              </div>

              <div class="form-group">
                <label for="unite" class="required">{% if lang == 'en' %}Unit{% else %}Unit√©{% endif %} :</label>
                <select name="unite_id" id="unite" required disabled>
                  <option value="">{% if lang == 'en' %}-- Choose unit --{% else %}-- Choisir une unit√© --{% endif %}</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Section Exercices -->
          <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-tasks"></i> {% if lang == 'en' %}Exercises{% else %}Exercices{% endif %}</h3>
            
            <input type="hidden" id="total_exercices" name="total_exercices" value="0">
            <div id="exercices-container">
              <div class="empty-state" id="empty-exercices">
                <i class="fas fa-clipboard-list"></i>
                <p>{% if lang == 'en' %}No exercises added yet. Click the button below to add your first exercise.{% else %}Aucun exercice ajout√© pour le moment. Cliquez sur le bouton ci-dessous pour ajouter votre premier exercice.{% endif %}</p>
              </div>
            </div>
            
            <div class="exercice-counter" id="exercice-counter" style="display: none;">
              {% if lang == 'en' %}Total exercises: <span id="exercice-count">0</span>{% else %}Total d'exercices: <span id="exercice-count">0</span>{% endif %}
            </div>

            <button type="button" class="btn-add-exercice" onclick="addExercice()">
              <i class="fas fa-plus-circle"></i> {% if lang == 'en' %}Add Exercise{% else %}Ajouter un exercice{% endif %}
            </button>
          </div>

          <!-- Section Param√®tres du test -->
          <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-cogs"></i> {% if lang == 'en' %}Test Settings{% else %}Param√®tres du test{% endif %}</h3>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="temps" class="required">{% if lang == 'en' %}Time (seconds){% else %}Temps (en secondes){% endif %} :</label>
                <input type="number" name="temps" id="temps" value="60" min="10" max="3600">
              </div>
            </div>
          </div>

          <!-- Section Fichiers -->
          <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-file-pdf"></i> {% if lang == 'en' %}PDF Files{% else %}Fichiers PDF{% endif %}</h3>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="fichier_pdf" class="required">{% if lang == 'en' %}Test PDF File{% else %}Fichier PDF du test{% endif %} :</label>
                <div class="file-upload">
                  <input type="file" name="fichier_pdf" id="fichier_pdf" accept=".pdf" required>
                  <label for="fichier_pdf" class="file-upload-label">
                    <i class="fas fa-file-pdf"></i>
                    <span id="pdf-file-name">{% if lang == 'en' %}Choose test PDF...{% else %}Choisir le PDF du test...{% endif %}</span>
                  </label>
                </div>
              </div>

              <div class="form-group">
                <label for="fichier_corrige">{% if lang == 'en' %}Correction PDF (optional){% else %}Corrig√© PDF (facultatif){% endif %} :</label>
                <div class="file-upload">
                  <input type="file" name="fichier_corrige" id="fichier_corrige" accept=".pdf">
                  <label for="fichier_corrige" class="file-upload-label">
                    <i class="fas fa-file-pdf"></i>
                    <span id="corrige-file-name">{% if lang == 'en' %}Choose correction PDF...{% else %}Choisir le PDF du corrig√©...{% endif %}</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <button type="submit" class="submit-button" id="submitBtn">
            <i class="fas fa-save"></i> {% if lang == 'en' %}Save Test{% else %}Enregistrer le test{% endif %}
          </button>
        </form>
      </div>
    </div>

    <div class="back-link">
      <a href="{{ dashboard_url }}">
        <i class="fas fa-arrow-left"></i> {% if lang == 'en' %}Back to dashboard{% else %}Retour au tableau de bord{% endif %}
      </a>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <script>
    // Variables globales
    let exerciceIndex = 0;
    const langJs = "{{ lang }}";
    const submitBtn = document.getElementById("submitBtn");
    const notification = document.getElementById("notification");

    // Initialisation au chargement de la page
    document.addEventListener("DOMContentLoaded", () => {
      // Initialiser l'upload de fichiers
      initFileUpload();
      
      // Initialiser les √©couteurs d'√©v√©nements pour les s√©lecteurs
      initSelectors();
      
      // Ajouter un exercice par d√©faut
      addExercice();
    });

    // Initialiser l'upload de fichiers
    function initFileUpload() {
      const pdfInput = document.getElementById("fichier_pdf");
      const pdfFileName = document.getElementById("pdf-file-name");
      const corrigeInput = document.getElementById("fichier_corrige");
      const corrigeFileName = document.getElementById("corrige-file-name");
      
      pdfInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          pdfFileName.textContent = this.files[0].name;
        } else {
          pdfFileName.textContent = langJs === 'en' ? 'Choose test PDF...' : 'Choisir le PDF du test...';
        }
      });
      
      corrigeInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          corrigeFileName.textContent = this.files[0].name;
        } else {
          corrigeFileName.textContent = langJs === 'en' ? 'Choose correction PDF...' : 'Choisir le PDF du corrig√©...';
        }
      });
    }

    // Initialiser les s√©lecteurs (niveau, mati√®re, unit√©)
    function initSelectors() {
      const niveauSelect = document.getElementById("niveau");
      const matiereSelect = document.getElementById("matiere");
      const uniteSelect = document.getElementById("unite");

      // Gestion du changement de niveau
      niveauSelect.addEventListener("change", function () {
        const niveauId = this.value;
        matiereSelect.innerHTML = "";
        uniteSelect.innerHTML = "";
        uniteSelect.disabled = true;

        if (!niveauId) {
          matiereSelect.disabled = true;
          return;
        }

        // Afficher un indicateur de chargement
        matiereSelect.innerHTML = `<option value="">${langJs === 'en' ? 'Loading...' : 'Chargement...'}</option>`;
        
        fetch(`/matiere-par-niveau/${niveauId}`)
          .then(res => res.json())
          .then(data => {
            matiereSelect.disabled = false;
            matiereSelect.innerHTML = `<option value="">${langJs === 'en' ? '-- Choose subject --' : '-- Choisir une mati√®re --'}</option>`;
            data.forEach(m => {
              matiereSelect.innerHTML += `<option value="${m.id}">${m.nom}</option>`;
            });
          })
          .catch(error => {
            console.error('Error loading subjects:', error);
            matiereSelect.innerHTML = `<option value="">${langJs === 'en' ? 'Error loading subjects' : 'Erreur lors du chargement des mati√®res'}</option>`;
          });
      });

      // Gestion du changement de mati√®re
      matiereSelect.addEventListener("change", function () {
        const matiereId = this.value;
        const uniteSelect = document.getElementById("unite");

        uniteSelect.innerHTML = "";
        if (!matiereId) {
          uniteSelect.disabled = true;
          return;
        }

        // Afficher un indicateur de chargement
        uniteSelect.innerHTML = `<option value="">${langJs === 'en' ? 'Loading...' : 'Chargement...'}</option>`;
        
        fetch(`/unites-par-matiere/${matiereId}`)
          .then(res => res.json())
          .then(data => {
            uniteSelect.disabled = false;
            uniteSelect.innerHTML = `<option value="">${langJs === 'en' ? '-- Choose unit --' : '-- Choisir une unit√© --'}</option>`;
            data.forEach(u => {
              uniteSelect.innerHTML += `<option value="${u.id}">${u.nom}</option>`;
            });
          })
          .catch(error => {
            console.error('Error loading units:', error);
            uniteSelect.innerHTML = `<option value="">${langJs === 'en' ? 'Error loading units' : 'Erreur lors du chargement des unit√©s'}</option>`;
          });
      });
    }

    // Cr√©er un champ de formulaire
    function addField(name, label) {
      return `
        <div class="form-group">
          <label class="required">${label} :</label>
          <textarea name="${name}_${exerciceIndex}" id="${name}_${exerciceIndex}" rows="3" required></textarea>
          <math-field id="math_${name}_${exerciceIndex}" virtual-keyboard-mode="onfocus" class="math-editor" placeholder="${langJs === 'en' ? 'Write math formulas here' : '√âcrivez des formules math√©matiques ici'}"></math-field>
          <button type="button" class="btn-insert" onclick="insertMath('math_${name}_${exerciceIndex}', '${name}_${exerciceIndex}')">
            <i class="fas fa-plus"></i> ${langJs === 'en' ? 'Insert into' : 'Ins√©rer dans'} ${label.toLowerCase()}
          </button>
        </div>
      `;
    }

    // Ajouter un exercice
    function addExercice() {
      const container = document.getElementById("exercices-container");
      const emptyState = document.getElementById("empty-exercices");
      
      // Masquer l'√©tat vide s'il est affich√©
      if (emptyState) {
        emptyState.style.display = 'none';
      }
      
      // Afficher le compteur d'exercices
      const counter = document.getElementById("exercice-counter");
      counter.style.display = 'block';

      const block = document.createElement("div");
      block.className = "exercice-block";
      block.id = `exercice-${exerciceIndex}`;
      block.innerHTML = `
        <div class="exercice-header">
          <div class="exercice-title">
            <i class="fas fa-tasks"></i> ${langJs === 'en' ? 'Exercise' : 'Exercice'} ${exerciceIndex + 1}
          </div>
          <button type="button" class="btn-remove" onclick="removeExercice(${exerciceIndex})">
            <i class="fas fa-trash"></i> ${langJs === 'en' ? 'Remove' : 'Supprimer'}
          </button>
        </div>

        <!-- Onglets pour les langues -->
        <div class="language-tabs">
          <div class="tab active" data-tab="french-${exerciceIndex}">üá´üá∑ Fran√ßais</div>
          <div class="tab" data-tab="english-${exerciceIndex}">üá¨üáß English</div>
        </div>

        <!-- Contenu fran√ßais -->
        <div class="tab-content active" id="french-${exerciceIndex}">
          ${addField("question_fr", "Question")}
          ${addField("reponse_fr", "R√©ponse attendue")}
          ${addField("explication_fr", "Explication")}
        </div>

        <!-- Contenu anglais -->
        <div class="tab-content" id="english-${exerciceIndex}">
          ${addField("question_en", "Question")}
          ${addField("reponse_en", "Expected answer")}
          ${addField("explication_en", "Explanation")}
        </div>

        <div class="form-group">
          <label>üì∑ ${langJs === 'en' ? 'Exercise image (optional)' : 'Image de l\'exercice (optionnel)'} :</label>
          <input type="file" name="image_${exerciceIndex}" accept="image/*">
        </div>
      `;

      container.appendChild(block);
      
      // Initialiser les onglets pour cet exercice
      initTabsForExercice(exerciceIndex);
      
      exerciceIndex++;
      document.getElementById("total_exercices").value = exerciceIndex;
      updateExerciceCounter();
    }

    // Initialiser les onglets pour un exercice
    function initTabsForExercice(index) {
      const tabs = document.querySelectorAll(`#exercice-${index} .tab`);
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Retirer la classe active de tous les onglets de cet exercice
          document.querySelectorAll(`#exercice-${index} .tab`).forEach(t => {
            t.classList.remove('active');
          });
          
          // Ajouter la classe active √† l'onglet cliqu√©
          tab.classList.add('active');
          
          // Masquer tous les contenus de cet exercice
          document.querySelectorAll(`#exercice-${index} .tab-content`).forEach(content => {
            content.classList.remove('active');
          });
          
          // Afficher le contenu correspondant
          const tabId = tab.getAttribute('data-tab');
          document.getElementById(tabId).classList.add('active');
        });
      });
    }

    // Supprimer un exercice
    function removeExercice(index) {
      const exercice = document.getElementById(`exercice-${index}`);
      if (exercice) {
        exercice.remove();
        exerciceIndex--;
        document.getElementById("total_exercices").value = exerciceIndex;
        updateExerciceCounter();
        
        // Afficher l'√©tat vide si aucun exercice n'existe
        if (exerciceIndex === 0) {
          const emptyState = document.getElementById("empty-exercices");
          if (emptyState) {
            emptyState.style.display = 'block';
          }
          const counter = document.getElementById("exercice-counter");
          counter.style.display = 'none';
        }
        
        showNotification(
          langJs === 'en' ? 'Exercise removed successfully!' : 'Exercice supprim√© avec succ√®s !', 
          'success'
        );
      }
    }

    // Mettre √† jour le compteur d'exercices
    function updateExerciceCounter() {
      const countElement = document.getElementById("exercice-count");
      if (countElement) {
        countElement.textContent = exerciceIndex;
      }
    }

    // Ins√©rer du LaTeX dans un champ de texte
    function insertMath(mathId, inputId) {
      const mathField = document.getElementById(mathId);
      const input = document.getElementById(inputId);
      const formula = mathField.value;

      if (!formula || !input) {
        showNotification(
          langJs === 'en' ? 'Please enter a formula first' : 'Veuillez d\'abord saisir une formule', 
          'error'
        );
        return;
      }

      const start = input.selectionStart;
      const end = input.selectionEnd;
      const before = input.value.substring(0, start);
      const after = input.value.substring(end);

      input.value = before + formula + after;
      input.focus();
      input.selectionStart = input.selectionEnd = start + formula.length;

      mathField.value = '';
      
      showNotification(
        langJs === 'en' ? 'Formula inserted successfully!' : 'Formule ins√©r√©e avec succ√®s !', 
        'success'
      );
    }

    // Afficher une notification
    function showNotification(message, type) {
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Gestion de la soumission du formulaire
    document.getElementById('testForm').addEventListener('submit', function(e) {
      // Validation basique
      const requiredFields = this.querySelectorAll('[required]');
      let isValid = true;
      
      requiredFields.forEach(field => {
        if (!field.value.trim()) {
          isValid = false;
          field.style.borderColor = '#e74c3c';
        } else {
          field.style.borderColor = '';
        }
      });
      
      // V√©rifier qu'au moins un exercice a √©t√© ajout√©
      if (exerciceIndex === 0) {
        isValid = false;
        showNotification(
          langJs === 'en' ? 'Please add at least one exercise' : 'Veuillez ajouter au moins un exercice', 
          'error'
        );
      }
      
      if (!isValid) {
        e.preventDefault();
        showNotification(
          langJs === 'en' ? 'Please fill in all required fields' : 'Veuillez remplir tous les champs obligatoires', 
          'error'
        );
        return;
      }
      
      // Afficher un indicateur de chargement
      submitBtn.innerHTML = `<span class="loading"></span> ${langJs === 'en' ? 'Saving...' : 'Enregistrement en cours...'}`;
      submitBtn.disabled = true;
    });
  </script>
</body>
</html>