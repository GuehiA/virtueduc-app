<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Favicon VirtuEduc -->
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon/favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon/favicon-16x16.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='favicon/site.webmanifest') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon/favicon.ico') }}">
  <meta name="msapplication-TileColor" content="#4361ee">
  <meta name="theme-color" content="#4361ee">
  <title>{% if lang == 'en' %}Validated Remediations{% else %}Remédiations Validées{% endif %}</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #3498db;
      --primary-dark: #2980b9;
      --secondary: #2c3e50;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --border-radius: 12px;
      --box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 30px 15px;
      color: var(--dark);
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    h2 {
      color: white;
      font-size: 2.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 8px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    h2 i {
      color: #f1c40f;
      font-size: 2.5rem;
    }

    .subtitle {
      color: rgba(255, 255, 255, 0.9);
      font-size: 1.1rem;
    }

    .stats-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 25px;
      text-align: center;
      box-shadow: var(--box-shadow);
      backdrop-filter: blur(10px);
    }

    .stats-number {
      font-size: 2.5rem;
      font-weight: bold;
      color: var(--success);
      margin-bottom: 5px;
    }

    .stats-label {
      font-size: 1rem;
      color: var(--secondary);
      font-weight: 600;
    }

    .remediations-grid {
      display: grid;
      gap: 20px;
      margin-bottom: 30px;
    }

    .remediation-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--box-shadow);
      border: 1px solid #e9ecef;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .remediation-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(0,0,0,0.15);
    }

    .remediation-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(to bottom, var(--success), #219150);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 18px;
      gap: 12px;
    }

    .theme-info {
      flex: 1;
    }

    .theme-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--secondary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      line-height: 1.3;
    }

    .theme-title i {
      color: var(--primary);
      flex-shrink: 0;
    }

    .lesson-info {
      color: var(--gray);
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-badge {
      background: linear-gradient(135deg, var(--success), #219150);
      color: white;
      padding: 6px 14px;
      border-radius: 18px;
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
      flex-shrink: 0;
    }

    /* Sections compactes */
    .content-section {
      margin: 15px 0;
      border-radius: 8px;
      padding: 16px;
      border-left: 4px solid;
    }

    .message-section {
      background: rgba(52, 152, 219, 0.05);
      border-left-color: var(--primary);
    }

    .exercise-section {
      background: rgba(243, 156, 18, 0.05);
      border-left-color: var(--warning);
    }

    .submission-section {
      background: rgba(39, 174, 96, 0.05);
      border-left-color: var(--success);
    }

    .ai-feedback {
      background: rgba(155, 89, 182, 0.05);
      border-left-color: #9b59b6;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--secondary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-title i {
      width: 14px;
      flex-shrink: 0;
    }

    .message-section .section-title i { color: var(--primary); }
    .exercise-section .section-title i { color: var(--warning); }
    .submission-section .section-title i { color: var(--success); }
    .ai-feedback .section-title i { color: #9b59b6; }

    /* CONTENU D'EXERCICE AMÉLIORÉ */
    .exercise-content {
      background: white;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #e9ecef;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      font-size: 0.95rem;
      white-space: normal;
      word-wrap: break-word;
    }

    .exercise-content .exercise-line {
      margin-bottom: 10px;
      padding-left: 0;
      text-indent: 0;
    }

    .exercise-content .exercise-title {
      font-weight: 600;
      color: var(--secondary);
      margin-bottom: 8px;
      font-size: 1rem;
    }

    .exercise-content .question {
      margin-bottom: 12px;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .exercise-content .question:last-child {
      border-bottom: none;
    }

    .exercise-content .question-number {
      font-weight: 600;
      color: var(--primary);
      margin-right: 5px;
    }

    .math-content {
      line-height: 1.5;
      margin-top: 8px;
      font-size: 0.95rem;
      white-space: normal;
      word-wrap: break-word;
    }

    .actions {
      text-align: center;
      margin: 20px 0 12px 0;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: var(--transition);
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success), #219150);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(39, 174, 96, 0.3);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3);
    }

    .date-info {
      text-align: right;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid #e9ecef;
    }

    .date {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--light);
      padding: 6px 12px;
      border-radius: 16px;
      color: var(--gray);
      font-size: 0.85rem;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .empty-state i {
      font-size: 4rem;
      color: #e9ecef;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      color: var(--secondary);
      margin-bottom: 12px;
      font-size: 1.6rem;
    }

    .empty-state p {
      color: var(--gray);
      font-size: 1rem;
      margin-bottom: 25px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    .navigation {
      text-align: center;
      margin-top: 30px;
    }

    .btn-back {
      background: linear-gradient(135deg, var(--secondary), #1a252f);
      color: white;
      padding: 12px 30px;
      font-size: 1rem;
    }

    .btn-back:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(44, 62, 80, 0.3);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .remediation-card {
      animation: fadeInUp 0.5s ease;
    }

    .remediation-card:nth-child(even) {
      animation-delay: 0.1s;
    }

    .remediation-card:nth-child(odd) {
      animation-delay: 0.2s;
    }

    /* Responsive Design amélioré */
    @media (max-width: 768px) {
      body {
        padding: 20px 10px;
      }

      h2 {
        font-size: 1.8rem;
        flex-direction: column;
        gap: 8px;
      }

      .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .status-badge {
        align-self: flex-start;
      }

      .stats-number {
        font-size: 2.2rem;
      }

      .remediation-card {
        padding: 20px;
      }

      .content-section {
        padding: 14px;
        margin: 12px 0;
      }
    }

    @media (max-width: 480px) {
      h2 {
        font-size: 1.5rem;
      }

      .theme-title {
        font-size: 1.1rem;
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }

      .remediation-card {
        padding: 16px;
      }

      .content-section {
        padding: 12px;
      }

      .exercise-content {
        padding: 12px;
        font-size: 0.9rem;
      }
    }

    /* Styles pour le rendu MathJax */
    .math-content mjx-container {
      display: inline-block !important;
      margin: 3px 0 !important;
    }
  </style>
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
</head>
<body>

<div class="container">
  <div class="header">
    <h2>
      <i class="fas fa-check-double"></i>
      {% if lang == 'en' %}Validated Remediations{% else %}Remédiations Validées{% endif %}
    </h2>
    <p class="subtitle">
      {% if lang == 'en' %}Your personalized learning journey{% else %}Votre parcours d'apprentissage personnalisé{% endif %}
    </p>
  </div>

  {% if remediations %}
    <div class="stats-card">
      <div class="stats-number">{{ remediations|length }}</div>
      <div class="stats-label">
        {% if lang == 'en' %}remediation(s) available{% else %}remédiation(s) disponible(s){% endif %}
      </div>
    </div>

    <div class="remediations-grid">
      {% for r in remediations %}
        <div class="remediation-card">
          <div class="card-header">
            <div class="theme-info">
              <div class="theme-title">
                <i class="fas fa-book-open"></i>
                {{ r.theme }} – {{ r.lecon }}
              </div>
              <div class="lesson-info">
                <i class="fas fa-graduation-cap"></i>
                {% if lang == 'en' %}Personalized remediation{% else %}Remédiation personnalisée{% endif %}
              </div>
            </div>
            <div class="status-badge">
              <i class="fas fa-check"></i>
              {% if r.reponse_eleve %}
                {% if lang == 'en' %}Completed{% else %}Terminée{% endif %}
              {% else %}
                {% if lang == 'en' %}Pending{% else %}En attente{% endif %}
              {% endif %}
            </div>
          </div>

          <!-- Message Section -->
          <div class="content-section message-section">
            <div class="section-title">
              <i class="fas fa-comment-dots"></i>
              {% if lang == 'en' %}Teacher's Message{% else %}Message de l'enseignant{% endif %}
            </div>
            <div class="math-content">{{ r.message }}</div>
          </div>

          <!-- Exercise Section - FORMATAGE AMÉLIORÉ -->
          {% if r.exercice_suggere %}
            <div class="content-section exercise-section">
              <div class="section-title">
                <i class="fas fa-pencil-alt"></i>
                {% if lang == 'en' %}Remediation Exercise{% else %}Exercice de remédiation{% endif %}
              </div>
              <div class="exercise-content" id="exercise-{{ r.id }}">
                {# Le contenu sera formaté par JavaScript #}
                {{ r.exercice_suggere }}
              </div>
            </div>
          {% endif %}

          <!-- Student Submission Section -->
          {% if r.reponse_eleve %}
            <div class="content-section submission-section">
              <div class="section-title">
                <i class="fas fa-user-check"></i>
                {% if lang == 'en' %}Your Submission{% else %}Votre travail{% endif %}
              </div>
              <div class="math-content">{{ r.reponse_eleve }}</div>
            </div>

            <!-- AI Feedback Section -->
            {% if r.analyse_ia %}
              <div class="content-section ai-feedback">
                <div class="section-title">
                  <i class="fas fa-robot"></i>
                  {% if lang == 'en' %}AI Feedback{% else %}Analyse IA{% endif %}
                </div>
                <div class="math-content">{{ r.analyse_ia }}</div>
              </div>
            {% endif %}
          {% else %}
            <!-- Action Button for Pending Remediation -->
            <div class="actions">
              <a href="/eleve/remediation/{{ r.id }}?lang={{ lang }}" class="btn btn-success">
                <i class="fas fa-play-circle"></i>
                {% if lang == 'en' %}Start This Remediation{% else %}Commencer cette remédiation{% endif %}
              </a>
            </div>
          {% endif %}

          <!-- Date Information -->
          <div class="date-info">
            <div class="date" data-date="{{ r.timestamp.isoformat() }}">
              <i class="fas fa-clock"></i>
              <span class="date-text">...</span>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-state">
      <i class="fas fa-inbox"></i>
      <h3>{% if lang == 'en' %}No Remediations Yet{% else %}Aucune remédiation pour l'instant{% endif %}</h3>
      <p>
        {% if lang == 'en' %}
          Your teacher will assign personalized remediations soon. Check back later!
        {% else %}
          Votre enseignant vous assignera bientôt des remédiations personnalisées. Revenez plus tard !
        {% endif %}
      </p>
      <a href="/dashboard-eleve?username={{ eleve.username }}" class="btn btn-primary">
        <i class="fas fa-home"></i>
        {% if lang == 'en' %}Return to Dashboard{% else %}Retour au tableau de bord{% endif %}
      </a>
    </div>
  {% endif %}

  <!-- Navigation -->
  <div class="navigation">
    <a href="/dashboard-eleve?username={{ eleve.username }}" class="btn btn-back">
      <i class="fas fa-arrow-left"></i>
      {% if lang == 'en' %}Back to Dashboard{% else %}Retour au tableau de bord{% endif %}
    </a>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Format dates
    const dateElements = document.querySelectorAll(".date");
    const lang = "{{ lang }}";
    dateElements.forEach(el => {
      const utc = el.getAttribute("data-date");
      if (utc) {
        const local = new Date(utc);
        const dateText = el.querySelector('.date-text');
        dateText.textContent = local.toLocaleString(lang === "fr" ? 'fr-FR' : 'en-GB');
      }
    });

    // FORMATAGE DES EXERCICES - CORRECTION DES PROBLÈMES
    function formatExerciseContent(exerciseElement) {
      let content = exerciseElement.textContent || exerciseElement.innerText;
      
      // Nettoyer le contenu
      content = content.trim();
      
      // Supprimer les lignes indésirables (réponses, explications)
      const lines = content.split('\n').filter(line => {
        const trimmed = line.trim();
        return !trimmed.match(/^(Réponse attendue|Expected answer|Explication|Explanation)/i) && 
               trimmed.length > 0;
      });

      // Reconstruire le contenu avec un formatage propre
      let formattedContent = '';
      
      lines.forEach((line, index) => {
        const trimmed = line.trim();
        
        // Identifier les titres/questions
        if (trimmed.match(/^(Exercice|Exercise|Problème|Problem|Question)/i) || 
            (trimmed.endsWith(':') && lines[index + 1] && !lines[index + 1].trim().match(/^[a-z]/))) {
          if (formattedContent) formattedContent += '<br><br>';
          formattedContent += `<div class="exercise-title">${trimmed}</div>`;
        }
        // Identifier les numéros de question (1., 2., a), b), etc.)
        else if (trimmed.match(/^(\d+\.|\d+\)|[a-z]\)|\•)/)) {
          if (formattedContent) formattedContent += '<br>';
          formattedContent += `<div class="question"><span class="question-number">${trimmed.split(' ')[0]}</span> ${trimmed.substring(trimmed.indexOf(' ') + 1)}</div>`;
        }
        // Lignes normales
        else {
          if (formattedContent && !formattedContent.endsWith('<br>')) {
            formattedContent += '<br>';
          }
          formattedContent += `<div class="exercise-line">${trimmed}</div>`;
        }
      });

      exerciseElement.innerHTML = formattedContent || '<div class="exercise-line">' + content + '</div>';
    }

    // Appliquer le formatage à tous les exercices
    document.querySelectorAll('.exercise-content').forEach(formatExerciseContent);

    // Animation d'apparition progressive
    const cards = document.querySelectorAll('.remediation-card');
    cards.forEach((card, index) => {
      card.style.animationDelay = `${index * 0.1}s`;
    });

    // Re-trigger MathJax after content formatting
    setTimeout(() => {
      if (window.MathJax) {
        window.MathJax.typesetPromise();
      }
    }, 800);
  });
</script>

</body>
</html>