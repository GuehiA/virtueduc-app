<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Favicon VirtuEduc -->
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon/favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon/favicon-16x16.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='favicon/site.webmanifest') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon/favicon.ico') }}">
  <meta name="msapplication-TileColor" content="#4361ee">
  <meta name="theme-color" content="#4361ee">
  <title>{% if lang == 'en' %}Edit Final Test{% else %}Modifier un test sommatif{% endif %}</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive.core.css">
  <script defer src="https://unpkg.com/mathlive"></script>
  <style>
    :root {
      --primary: #3498db;
      --primary-dark: #2980b9;
      --secondary: #2c3e50;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --border-radius: 16px;
      --box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
      color: var(--dark);
      line-height: 1.6;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .form-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 40px;
      position: relative;
      overflow: hidden;
    }

    .form-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, var(--primary), var(--success), var(--warning));
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 25px;
      border-bottom: 2px solid var(--light);
    }

    h1 {
      color: var(--secondary);
      font-size: 2.5rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    h1 i {
      color: var(--primary);
      font-size: 2.8rem;
    }

    .subtitle {
      color: var(--gray);
      font-size: 1.2rem;
    }

    .form-grid {
      display: grid;
      gap: 30px;
    }

    .form-section {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 12px;
      padding: 30px;
      border-left: 4px solid var(--primary);
    }

    .section-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--secondary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      color: var(--primary);
    }

    .form-group {
      margin-bottom: 25px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--secondary);
      font-size: 1rem;
    }

    select, input[type="number"], input[type="text"], input[type="file"] {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1rem;
      transition: var(--transition);
      background: white;
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    textarea {
      width: 100%;
      min-height: 120px;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      resize: vertical;
      font-size: 1rem;
      font-family: inherit;
      line-height: 1.5;
      transition: var(--transition);
      background: white;
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .math-input-group {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-top: 15px;
      border: 2px solid #e9ecef;
    }

    .math-input-label {
      font-weight: 600;
      margin-bottom: 10px;
      display: block;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    math-field {
      width: 100%;
      min-height: 60px;
      border: 2px solid var(--gray);
      border-radius: 8px;
      padding: 12px;
      font-size: 16px;
      background: white;
      transition: var(--transition);
    }

    math-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: var(--transition);
      border: none;
      cursor: pointer;
      font-size: 1rem;
    }

    .btn-insert {
      background: linear-gradient(135deg, var(--warning), #e67e22);
      color: white;
      margin-top: 10px;
      width: 100%;
      justify-content: center;
    }

    .btn-insert:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(243, 156, 18, 0.3);
    }

    .btn-submit {
      background: linear-gradient(135deg, var(--success), #219150);
      color: white;
      padding: 15px 30px;
      font-size: 1.1rem;
      margin-top: 30px;
      width: 100%;
      justify-content: center;
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
    }

    .btn-back {
      background: linear-gradient(135deg, var(--secondary), #1a252f);
      color: white;
      margin-top: 20px;
      width: 100%;
      justify-content: center;
      text-align: center;
    }

    .btn-back:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(44, 62, 80, 0.3);
    }

    .file-preview {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0;
      border: 2px dashed #e9ecef;
    }

    .file-preview iframe {
      width: 100%;
      height: 400px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .file-label {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .exercises-section {
      background: linear-gradient(135deg, #fff9e6, #ffeaa7);
      border-radius: 12px;
      padding: 30px;
      border-left: 4px solid var(--warning);
    }

    .exercise-card {
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      border: 1px solid #e9ecef;
      position: relative;
    }

    .exercise-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(to bottom, var(--warning), #e67e22);
    }

    .exercise-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--light);
    }

    .exercise-number {
      background: linear-gradient(135deg, var(--warning), #e67e22);
      color: white;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1rem;
    }

    .exercise-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--secondary);
    }

    .language-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #e9ecef;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      border-bottom: 3px solid transparent;
      color: var(--gray);
    }

    .tab.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .fields-grid {
      display: grid;
      gap: 20px;
    }

    hr {
      border: none;
      border-top: 2px solid #e9ecef;
      margin: 30px 0;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .exercise-card {
      animation: fadeIn 0.6s ease;
    }

    .exercise-card:nth-child(even) {
      animation-delay: 0.1s;
    }

    .exercise-card:nth-child(odd) {
      animation-delay: 0.2s;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        padding: 20px 15px;
      }

      .form-container {
        padding: 30px 20px;
      }

      h1 {
        font-size: 2rem;
        flex-direction: column;
        gap: 10px;
      }

      .language-tabs {
        flex-direction: column;
      }

      .tab {
        text-align: center;
      }

      .exercise-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .file-preview iframe {
        height: 300px;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.6rem;
      }

      .form-section, .exercises-section {
        padding: 20px;
      }

      .exercise-card {
        padding: 20px;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="form-container">
    <!-- En-tÃªte -->
    <div class="header">
      <h1>
        <i class="fas fa-edit"></i>
        {% if lang == 'en' %}Edit Final Test{% else %}Modifier le Test Sommatif{% endif %}
      </h1>
      <p class="subtitle">
        {% if lang == 'en' %}
          Update test details and exercises
        {% else %}
          Modifiez les dÃ©tails du test et ses exercices
        {% endif %}
      </p>
    </div>

    <!-- Messages Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" style="
            background: {% if category == 'success' %}#d4edda{% else %}#f8d7da{% endif %};
            border: 1px solid {% if category == 'success' %}#c3e6cb{% else %}#f5c6cb{% endif %};
            color: {% if category == 'success' %}#155724{% else %}#721c24{% endif %};
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
          ">
            <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' }}"></i>
            {{ message }}
            <button type="button" style="
              background: none;
              border: none;
              font-size: 1.2rem;
              margin-left: auto;
              cursor: pointer;
              color: inherit;
            " onclick="this.parentElement.style.display='none'">Ã—</button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" enctype="multipart/form-data">
      <div class="form-grid">
        <!-- Section Configuration de base -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-cog"></i>
            {% if lang == 'en' %}Basic Configuration{% else %}Configuration de base{% endif %}
          </div>

          <div class="form-group">
            <label for="unite_id">
              <i class="fas fa-book"></i>
              {% if lang == 'en' %}Unit{% else %}UnitÃ©{% endif %}
            </label>
            <select name="unite_id" id="unite_id" required>
              {% for unite in unites %}
                <option value="{{ unite.id }}" {% if unite.id == test.unite_id %}selected{% endif %}>
                  {{ unite.nom_en if lang == 'en' and unite.nom_en else unite.nom }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="temps">
              <i class="fas fa-clock"></i>
              {% if lang == 'en' %}Time (seconds){% else %}Temps (en secondes){% endif %}
            </label>
            <input type="number" name="temps" id="temps" value="{{ test.temps or 60 }}" min="1" required>
          </div>
        </div>

        <!-- Section Fichiers PDF -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-file-pdf"></i>
            {% if lang == 'en' %}PDF Documents{% else %}Documents PDF{% endif %}
          </div>

          <!-- Fichier PDF actuel -->
          {% if test.chemin_fichier %}
            <div class="file-preview">
              <div class="file-label">
                <i class="fas fa-eye"></i>
                {% if lang == 'en' %}Current PDF File{% else %}Fichier PDF actuel{% endif %}
              </div>
              <iframe src="{{ url_for('static', filename=test.chemin_fichier) }}"></iframe>
            </div>
          {% endif %}

          <div class="form-group">
            <label for="fichier_pdf">
              <i class="fas fa-upload"></i>
              {% if lang == 'en' %}Replace PDF file (optional){% else %}Remplacer le fichier PDF (optionnel){% endif %}
            </label>
            <input type="file" name="fichier_pdf" id="fichier_pdf" accept=".pdf">
          </div>

          <!-- CorrigÃ© PDF actuel -->
          {% if test.chemin_corrige %}
            <div class="file-preview">
              <div class="file-label">
                <i class="fas fa-check-circle"></i>
                {% if lang == 'en' %}Current Correction PDF{% else %}CorrigÃ© PDF actuel{% endif %}
              </div>
              <iframe src="{{ url_for('static', filename=test.chemin_corrige) }}"></iframe>
            </div>
          {% endif %}

          <div class="form-group">
            <label for="fichier_corrige">
              <i class="fas fa-upload"></i>
              {% if lang == 'en' %}Replace correction PDF (optional){% else %}Remplacer le corrigÃ© PDF (optionnel){% endif %}
            </label>
            <input type="file" name="fichier_corrige" id="fichier_corrige" accept=".pdf">
          </div>
        </div>

        <!-- Section Exercices -->
        <div class="exercises-section">
          <div class="section-title">
            <i class="fas fa-pencil-alt"></i>
            {% if lang == 'en' %}Test Exercises{% else %}Exercices du Test{% endif %}
            <span style="font-size: 1rem; color: var(--gray); margin-left: 10px;">
              ({{ test.exercices|length }} {% if lang == 'en' %}exercises{% else %}exercices{% endif %})
            </span>
          </div>

          <input type="hidden" name="total_ex" value="{{ test.exercices|length }}">

          {% for ex in test.exercices %}
            <div class="exercise-card">
              <div class="exercise-header">
                <div class="exercise-number">{{ loop.index }}</div>
                <div class="exercise-title">
                  {% if lang == 'en' %}Exercise{% else %}Exercice{% endif %} {{ loop.index }}
                </div>
              </div>

              <input type="hidden" name="ex_id_{{ loop.index }}" value="{{ ex.id }}">

              <!-- Onglets de langue -->
              <div class="language-tabs">
                <div class="tab active" data-tab="fr-{{ loop.index }}">ðŸ‡«ðŸ‡· FranÃ§ais</div>
                <div class="tab" data-tab="en-{{ loop.index }}">ðŸ‡¬ðŸ‡§ English</div>
              </div>

              <!-- Contenu FranÃ§ais -->
              <div class="tab-content active" id="fr-{{ loop.index }}">
                <div class="fields-grid">
                  <div class="form-group">
                    <label>Question FR</label>
                    <textarea name="question_fr_{{ loop.index }}" id="question_fr_{{ loop.index }}" placeholder="Saisissez la question en franÃ§ais...">{{ ex.question_fr }}</textarea>
                    
                    <div class="math-input-group">
                      <label class="math-input-label">
                        <i class="fas fa-square-root-variable"></i>
                        Ã‰diteur MathÃ©matique
                      </label>
                      <math-field id="math_fr_question_{{ loop.index }}" virtual-keyboard-mode="onfocus"></math-field>
                      <button type="button" class="btn btn-insert" onclick="insertMath('math_fr_question_{{ loop.index }}', 'question_fr_{{ loop.index }}')">
                        <i class="fas fa-plus"></i>
                        InsÃ©rer dans la question
                      </button>
                    </div>
                  </div>

                  <div class="form-group">
                    <label>RÃ©ponse FR</label>
                    <input type="text" name="reponse_fr_{{ loop.index }}" value="{{ ex.reponse_fr }}" placeholder="RÃ©ponse attendue en franÃ§ais">
                  </div>

                  <div class="form-group">
                    <label>Explication FR</label>
                    <textarea name="explication_fr_{{ loop.index }}" id="explication_fr_{{ loop.index }}" placeholder="Explication dÃ©taillÃ©e en franÃ§ais...">{{ ex.explication_fr }}</textarea>
                    
                    <div class="math-input-group">
                      <label class="math-input-label">
                        <i class="fas fa-square-root-variable"></i>
                        Ã‰diteur MathÃ©matique
                      </label>
                      <math-field id="math_fr_explication_{{ loop.index }}" virtual-keyboard-mode="onfocus"></math-field>
                      <button type="button" class="btn btn-insert" onclick="insertMath('math_fr_explication_{{ loop.index }}', 'explication_fr_{{ loop.index }}')">
                        <i class="fas fa-plus"></i>
                        InsÃ©rer dans l'explication
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Contenu Anglais -->
              <div class="tab-content" id="en-{{ loop.index }}">
                <div class="fields-grid">
                  <div class="form-group">
                    <label>Question EN</label>
                    <textarea name="question_en_{{ loop.index }}" id="question_en_{{ loop.index }}" placeholder="Enter the question in English...">{{ ex.question_en }}</textarea>
                    
                    <div class="math-input-group">
                      <label class="math-input-label">
                        <i class="fas fa-square-root-variable"></i>
                        Mathematical Editor
                      </label>
                      <math-field id="math_en_question_{{ loop.index }}" virtual-keyboard-mode="onfocus"></math-field>
                      <button type="button" class="btn btn-insert" onclick="insertMath('math_en_question_{{ loop.index }}', 'question_en_{{ loop.index }}')">
                        <i class="fas fa-plus"></i>
                        Insert into question
                      </button>
                    </div>
                  </div>

                  <div class="form-group">
                    <label>Expected Answer EN</label>
                    <input type="text" name="reponse_en_{{ loop.index }}" value="{{ ex.reponse_en }}" placeholder="Expected answer in English">
                  </div>

                  <div class="form-group">
                    <label>Explanation EN</label>
                    <textarea name="explication_en_{{ loop.index }}" id="explication_en_{{ loop.index }}" placeholder="Detailed explanation in English...">{{ ex.explication_en }}</textarea>
                    
                    <div class="math-input-group">
                      <label class="math-input-label">
                        <i class="fas fa-square-root-variable"></i>
                        Mathematical Editor
                      </label>
                      <math-field id="math_en_explication_{{ loop.index }}" virtual-keyboard-mode="onfocus"></math-field>
                      <button type="button" class="btn btn-insert" onclick="insertMath('math_en_explication_{{ loop.index }}', 'explication_en_{{ loop.index }}')">
                        <i class="fas fa-plus"></i>
                        Insert into explanation
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- Bouton de soumission -->
      <button type="submit" class="btn btn-submit">
        <i class="fas fa-save"></i>
        {% if lang == 'en' %}Save Changes{% else %}Enregistrer les modifications{% endif %}
      </button>
    </form>

    <!-- Navigation -->
    <a href="/admin/dashboard" class="btn btn-back">
      <i class="fas fa-arrow-left"></i>
      {% if lang == 'en' %}Back to dashboard{% else %}Retour au tableau de bord{% endif %}
    </a>
  </div>
</div>

<script>
  // CORRECTION DE LA FONCTION insertMath
  function insertMath(mathFieldId, textareaName) {
    console.log('InsertMath called with:', mathFieldId, textareaName);
    
    const mathField = document.getElementById(mathFieldId);
    // CORRECTION : Utiliser getElementById au lieu de getElementsByName
    const textArea = document.getElementById(textareaName);
    
    if (!mathField) {
      console.error('MathField not found:', mathFieldId);
      return;
    }
    
    if (!textArea) {
      console.error('TextArea not found:', textareaName);
      return;
    }

    const formula = mathField.value;
    console.log('Formula to insert:', formula);
    
    if (!formula) {
      alert('Veuillez saisir une formule mathÃ©matique avant d\'insÃ©rer.');
      return;
    }

    // Obtenir la position du curseur
    const startPos = textArea.selectionStart;
    const endPos = textArea.selectionEnd;
    
    // Construire le nouveau contenu
    const beforeText = textArea.value.substring(0, startPos);
    const afterText = textArea.value.substring(endPos);
    
    // InsÃ©rer la formule Ã  la position du curseur
    textArea.value = beforeText + formula + afterText;
    
    // Remettre le focus et positionner le curseur aprÃ¨s la formule insÃ©rÃ©e
    textArea.focus();
    textArea.selectionStart = textArea.selectionEnd = startPos + formula.length;
    
    // Feedback visuel
    mathField.style.borderColor = '#27ae60';
    mathField.style.boxShadow = '0 0 0 3px rgba(39, 174, 96, 0.1)';
    
    // RÃ©initialiser le champ mathÃ©matique
    mathField.value = '';
    
    // Restaurer l'apparence aprÃ¨s 1 seconde
    setTimeout(() => {
      mathField.style.borderColor = '';
      mathField.style.boxShadow = '';
    }, 1000);
    
    console.log('Formula inserted successfully');
  }

  // Gestion des onglets de langue
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing tabs...');
    
    const allTabs = document.querySelectorAll('.tab');
    
    allTabs.forEach(tab => {
      tab.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        const exerciseId = tabId.split('-')[1];
        
        console.log('Tab clicked:', tabId, 'Exercise:', exerciseId);
        
        // DÃ©sactiver tous les onglets de cet exercice
        document.querySelectorAll(`[data-tab^="fr-${exerciseId}"], [data-tab^="en-${exerciseId}"]`).forEach(t => {
          t.classList.remove('active');
        });
        
        // Activer l'onglet cliquÃ©
        this.classList.add('active');
        
        // Masquer tous les contenus de cet exercice
        document.querySelectorAll(`#fr-${exerciseId}, #en-${exerciseId}`).forEach(content => {
          content.classList.remove('active');
        });
        
        // Afficher le contenu correspondant
        const targetContent = document.getElementById(tabId);
        if (targetContent) {
          targetContent.classList.add('active');
          console.log('Activated content:', tabId);
        } else {
          console.error('Content not found:', tabId);
        }
      });
    });

    // Animation d'apparition progressive
    const cards = document.querySelectorAll('.exercise-card');
    cards.forEach((card, index) => {
      card.style.animationDelay = `${index * 0.1}s`;
    });

    // Initialisation des champs MathLive
    if (typeof MathLive !== 'undefined') {
      console.log('MathLive loaded successfully');
    } else {
      console.error('MathLive not loaded');
    }
  });

  // Gestion des erreurs
  window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
  });
</script>

</body>
</html>