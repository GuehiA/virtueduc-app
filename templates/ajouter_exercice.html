<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Favicon VirtuEduc -->
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon/favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon/favicon-16x16.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='favicon/site.webmanifest') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon/favicon.ico') }}">
  <meta name="msapplication-TileColor" content="#4361ee">
  <meta name="theme-color" content="#4361ee">
  <title>{% if lang == 'en' %}Add Exercise{% else %}Ajouter un exercice{% endif %}</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive.core.css">
  <style>
    :root {
      --primary: #3498db;
      --primary-dark: #2980b9;
      --secondary: #2c3e50;
      --secondary-dark: #1a252f;
      --success: #2ecc71;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --border-radius: 10px;
      --box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--dark);
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .lang-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      background: white;
      padding: 10px 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .lang-selector label {
      margin: 0;
      font-weight: 600;
    }

    .lang-selector select {
      border: 1px solid var(--light-gray);
      border-radius: 6px;
      padding: 8px 12px;
      background: white;
      cursor: pointer;
      transition: var(--transition);
    }

    .lang-selector select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .form-box {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
      margin-bottom: 30px;
    }

    .form-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 25px 30px;
      text-align: center;
    }

    .form-header h2 {
      font-size: 1.8rem;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .form-header p {
      opacity: 0.9;
      font-size: 1rem;
    }

    .form-body {
      padding: 30px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--secondary);
    }

    .required::after {
      content: " *";
      color: #e74c3c;
    }

    textarea, input, select, math-field {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--light-gray);
      border-radius: 8px;
      font-family: inherit;
      font-size: 1rem;
      transition: var(--transition);
    }

    textarea:focus, input:focus, select:focus, math-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
      white-space: pre-wrap;
    }

    math-field {
      min-height: 3.5em;
      margin-top: 5px;
    }

    .math-editor-container {
      position: relative;
      margin-bottom: 10px;
    }

    .math-editor-container math-field {
      border: 1px solid var(--light-gray);
      border-radius: 8px;
      padding: 10px;
    }

    .math-insert-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 5px;
    }

    .math-insert-btn:hover {
      background-color: var(--primary-dark);
    }

    .submit-button {
      width: 100%;
      background: linear-gradient(135deg, var(--success) 0%, #27ae60 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 15px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .submit-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 15px rgba(46, 204, 113, 0.4);
    }

    .back-link {
      text-align: center;
      margin-top: 25px;
    }

    .back-link a {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--secondary);
      color: white;
      padding: 12px 25px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: var(--transition);
    }

    .back-link a:hover {
      background: var(--secondary-dark);
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.1);
    }

    .file-upload {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }

    .file-upload input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      background: var(--light-gray);
      border: 2px dashed var(--gray);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .file-upload-label:hover {
      background: #dfe6e9;
      border-color: var(--primary);
    }

    .file-upload-label i {
      font-size: 1.5rem;
      color: var(--primary);
    }

    .form-section {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--light-gray);
    }

    .form-section-title {
      font-size: 1.3rem;
      color: var(--primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .language-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--light-gray);
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      border-bottom: 3px solid transparent;
    }

    .tab.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ‚úÖ NOUVEAU : Styles pour la section image am√©lior√©e */
    .image-section {
      background: linear-gradient(135deg, #fff3cd, #ffeaa7);
      border-radius: var(--border-radius);
      padding: 25px;
      margin: 30px 0;
      border-left: 4px solid #ffc107;
    }

    .image-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .image-header i {
      color: #e67e22;
      font-size: 1.5rem;
    }

    .image-header h3 {
      color: var(--secondary);
      font-size: 1.3rem;
    }

    .image-preview {
      margin: 15px 0;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border: 2px solid var(--light-gray);
      display: none;
    }

    .image-preview img {
      max-width: 300px;
      max-height: 200px;
      border-radius: 8px;
      display: block;
      margin-bottom: 10px;
    }

    .ai-description-info {
      background: linear-gradient(135deg, #e8f4fc, #d1ecf1);
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border-left: 4px solid var(--success);
    }

    .ai-description-info h4 {
      color: var(--primary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ai-description-info p {
      color: var(--gray);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .lang-selector {
        justify-content: center;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .form-body {
        padding: 20px;
      }
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      box-shadow: var(--box-shadow);
      z-index: 1000;
      transform: translateX(150%);
      transition: transform 0.4s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: var(--success);
    }

    .notification.error {
      background: #e74c3c;
    }
  </style>
  <script defer src="https://unpkg.com/mathlive"></script>
</head>
<body>
  <div class="container">
    <!-- Header avec s√©lecteur de langue -->
    <div class="header">
      <div class="lang-selector">
        <label for="lang">üåç</label>
        <form method="POST" action="/changer-langue" id="langForm">
          <select name="lang" id="lang" onchange="document.getElementById('langForm').submit()">
            <option value="fr" {% if lang == 'fr' %}selected{% endif %}>üá´üá∑ Fran√ßais</option>
            <option value="en" {% if lang == 'en' %}selected{% endif %}>üá¨üáß English</option>
          </select>
          <input type="hidden" name="redirect_page" value="ajouter_exercice">
        </form>
      </div>
    </div>

    <!-- Formulaire principal -->
    <div class="form-box">
      <div class="form-header">
        <h2><i class="fas fa-brain"></i> {% if lang == 'en' %}Add Exercise{% else %}Ajouter un exercice{% endif %}</h2>
        <p>{% if lang == 'en' %}Create a new exercise for your students{% else %}Cr√©ez un nouvel exercice pour vos √©tudiants{% endif %}</p>
      </div>

      <div class="form-body">
        <form method="POST" enctype="multipart/form-data" id="exerciseForm">
          <!-- Section Cat√©gorisation -->
          <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-folder-open"></i> {% if lang == 'en' %}Categorization{% else %}Cat√©gorisation{% endif %}</h3>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="niveau" class="required">{% if lang == 'en' %}Level{% else %}Niveau{% endif %} :</label>
                <select name="niveau_id" id="niveau" required>
                  <option value="">{% if lang == 'en' %}-- Choose level --{% else %}-- Choisir un niveau --{% endif %}</option>
                  {% for niveau in niveaux %}
                    <option value="{{ niveau.id }}">{{ niveau.nom_en if lang == 'en' and niveau.nom_en else niveau.nom }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group">
                <label for="matiere" class="required">{% if lang == 'en' %}Subject{% else %}Mati√®re{% endif %} :</label>
                <select id="matiere" required disabled>
                  <option value="">{% if lang == 'en' %}-- Choose subject --{% else %}-- Choisir une mati√®re --{% endif %}</option>
                </select>
              </div>

              <div class="form-group">
                <label for="unite" class="required">{% if lang == 'en' %}Unit{% else %}Unit√©{% endif %} :</label>
                <select id="unite" required disabled>
                  <option value="">{% if lang == 'en' %}-- Choose unit --{% else %}-- Choisir une unit√© --{% endif %}</option>
                </select>
              </div>

              <div class="form-group">
                <label for="lecon" class="required">{% if lang == 'en' %}Associated Lesson{% else %}Le√ßon associ√©e{% endif %} :</label>
                <select name="lecon_id" id="lecon" required disabled>
                  <option value="">{% if lang == 'en' %}-- Choose lesson --{% else %}-- Choisir une le√ßon --{% endif %}</option>
                </select>
              </div>
            </div>
          </div>

          <!-- ‚úÖ NOUVELLE SECTION : Image de l'exercice -->
          <div class="image-section">
            <div class="image-header">
              <i class="fas fa-image"></i>
              <h3>{% if lang == 'en' %}Exercise Image{% else %}Image de l'exercice{% endif %}</h3>
            </div>
            
            <div class="form-group">
              <label for="image_exercice">
                <i class="fas fa-upload"></i>
                {% if lang == 'en' %}Upload illustration image (optional){% else %}T√©l√©charger une image d'illustration (facultative){% endif %}
              </label>
              <div class="file-upload">
                <input type="file" name="image_exercice" id="image_exercice" accept="image/*">
                <label for="image_exercice" class="file-upload-label">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span id="file-name">{% if lang == 'en' %}Choose an image...{% else %}Choisir une image...{% endif %}</span>
                </label>
              </div>
            </div>

            <!-- Aper√ßu de l'image -->
            <div class="image-preview" id="imagePreview">
              <strong>{% if lang == 'en' %}Preview:{% else %}Aper√ßu :{% endif %}</strong>
              <img id="previewImage" src="#" alt="Preview">
              <div style="margin-top: 10px;">
                <small style="color: var(--gray);">
                  <i class="fas fa-file-image"></i>
                  <span id="fileName"></span>
                </small>
              </div>
            </div>

            <!-- Information sur la description IA -->
            <div class="ai-description-info">
              <h4>
                <i class="fas fa-robot"></i>
                {% if lang == 'en' %}AI-Powered Description{% else %}Description assist√©e par IA{% endif %}
              </h4>
              <p>
                {% if lang == 'en' %}
                When you upload an image, our AI will automatically generate descriptions in French and English to help understand visual elements. This improves feedback quality while reducing token usage.
                {% else %}
                Lorsque vous uploadez une image, notre IA g√©n√©rera automatiquement des descriptions en fran√ßais et en anglais pour aider √† comprendre les √©l√©ments visuels. Cela am√©liore la qualit√© des r√©troactions tout en r√©duisant l'utilisation de tokens.
                {% endif %}
              </p>
            </div>
          </div>

          <!-- Section Contenu de l'exercice -->
          <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-edit"></i> {% if lang == 'en' %}Exercise Content{% else %}Contenu de l'exercice{% endif %}</h3>
            
            <!-- Onglets pour les langues -->
            <div class="language-tabs">
              <div class="tab active" data-tab="french">üá´üá∑ Fran√ßais</div>
              <div class="tab" data-tab="english">üá¨üáß English</div>
            </div>

            <!-- Contenu fran√ßais -->
            <div class="tab-content active" id="french-content">
              <div class="form-group">
                <label for="question_fr" class="required">Question :</label>
                <textarea name="question_fr" id="question_fr" placeholder="Saisissez la question en fran√ßais">{{ request.form.get('question_fr') or '' }}</textarea>
                <div class="math-editor-container">
                  <math-field id="question_fr_field" virtual-keyboard-mode="onfocus" class="math-editor" placeholder="√âcrivez des formules math√©matiques ici"></math-field>
                </div>
                <button type="button" class="math-insert-btn" onclick="insererLatex('question_fr')">
                  <i class="fas fa-plus"></i> Ins√©rer dans la question
                </button>
              </div>

              <div class="form-group">
                <label for="options_fr">Options (s√©par√©es par des virgules) :</label>
                <textarea name="options_fr" id="options_fr" placeholder="Option 1, Option 2, Option 3, ...">{{ request.form.get('options_fr') or '' }}</textarea>
                <div class="math-editor-container">
                  <math-field id="options_fr_field" virtual-keyboard-mode="onfocus" class="math-editor" placeholder="√âcrivez des formules math√©matiques ici"></math-field>
                </div>
                <button type="button" class="math-insert-btn" onclick="insererLatex('options_fr')">
                  <i class="fas fa-plus"></i> Ins√©rer dans les options
                </button>
              </div>

              <div class="form-group">
                <label for="reponse_fr" class="required">R√©ponse :</label>
                <textarea name="reponse_fr" id="reponse_fr" placeholder="Saisissez la r√©ponse correcte">{{ request.form.get('reponse_fr') or '' }}</textarea>
                <div class="math-editor-container">
                  <math-field id="reponse_fr_field" virtual-keyboard-mode="onfocus" class="math-editor" placeholder="√âcrivez des formules math√©matiques ici"></math-field>
                </div>
                <button type="button" class="math-insert-btn" onclick="insererLatex('reponse_fr')">
                  <i class="fas fa-plus"></i> Ins√©rer dans la r√©ponse
                </button>
              </div>

              <div class="form-group">
                <label for="explication_fr">Explication :</label>
                <textarea name="explication_fr" id="explication_fr" placeholder="Expliquez la solution ou le raisonnement">{{ request.form.get('explication_fr') or '' }}</textarea>
                <div class="math-editor-container">
                  <math-field id="explication_fr_field" virtual-keyboard-mode="onfocus" class="math-editor" placeholder="√âcrivez des formules math√©matiques ici"></math-field>
                </div>
                <button type="button" class="math-insert-btn" onclick="insererLatex('explication_fr')">
                  <i class="fas fa-plus"></i> Ins√©rer dans l'explication
                </button>
              </div>
            </div>

            <!-- Contenu anglais -->
            <div class="tab-content" id="english-content">
              <div class="form-group">
                <label for="question_en" class="required">Question :</label>
                <textarea name="question_en" id="question_en" placeholder="Enter the question in English">{{ request.form.get('question_en') or '' }}</textarea>
                <div class="math-editor-container">
                  <math-field id="question_en_field" virtual-keyboard-mode="onfocus" class="math-editor" placeholder="Write math formulas here"></math-field>
                </div>
                <button type="button" class="math-insert-btn" onclick="insererLatex('question_en')">
                  <i class="fas fa-plus"></i> Insert into question
                </button>
              </div>

              <div class="form-group">
                <label for="options_en">Options (comma-separated) :</label>
                <textarea name="options_en" id="options_en" placeholder="Option 1, Option 2, Option 3, ...">{{ request.form.get('options_en') or '' }}</textarea>
                <div class="math-editor-container">
                  <math-field id="options_en_field" virtual-keyboard-mode="onfocus" class="math-editor" placeholder="Write math formulas here"></math-field>
                </div>
                <button type="button" class="math-insert-btn" onclick="insererLatex('options_en')">
                  <i class="fas fa-plus"></i> Insert into options
                </button>
              </div>

              <div class="form-group">
                <label for="reponse_en" class="required">Answer :</label>
                <textarea name="reponse_en" id="reponse_en" placeholder="Enter the correct answer">{{ request.form.get('reponse_en') or '' }}</textarea>
                <div class="math-editor-container">
                  <math-field id="reponse_en_field" virtual-keyboard-mode="onfocus" class="math-editor" placeholder="Write math formulas here"></math-field>
                </div>
                <button type="button" class="math-insert-btn" onclick="insererLatex('reponse_en')">
                  <i class="fas fa-plus"></i> Insert into answer
                </button>
              </div>

              <div class="form-group">
                <label for="explication_en">Explanation :</label>
                <textarea name="explication_en" id="explication_en" placeholder="Explain the solution or reasoning">{{ request.form.get('explication_en') or '' }}</textarea>
                <div class="math-editor-container">
                  <math-field id="explication_en_field" virtual-keyboard-mode="onfocus" class="math-editor" placeholder="Write math formulas here"></math-field>
                </div>
                <button type="button" class="math-insert-btn" onclick="insererLatex('explication_en')">
                  <i class="fas fa-plus"></i> Insert into explanation
                </button>
              </div>
            </div>
          </div>

          <!-- Section Param√®tres suppl√©mentaires -->
          <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-cogs"></i> {% if lang == 'en' %}Additional Settings{% else %}Param√®tres suppl√©mentaires{% endif %}</h3>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="temps" class="required">{% if lang == 'en' %}Time (seconds){% else %}Temps (en secondes){% endif %} :</label>
                <input type="number" name="temps" id="temps" value="60" min="10" max="600">
              </div>
            </div>
          </div>

          <button type="submit" class="submit-button" id="submitBtn">
            <i class="fas fa-plus-circle"></i> {% if lang == 'en' %}Add Exercise{% else %}Ajouter l'exercice{% endif %}
          </button>
        </form>
      </div>
    </div>

    <div class="back-link">
      <a href="{{ dashboard_url }}">
        <i class="fas fa-home"></i> {% if lang == 'en' %}Back to Dashboard{% else %}Retour au tableau de bord{% endif %}
      </a>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <script>
    // Variables globales
    const langJs = "{{ lang }}";
    const niveau = document.getElementById("niveau");
    const matiere = document.getElementById("matiere");
    const unite = document.getElementById("unite");
    const lecon = document.getElementById("lecon");
    const submitBtn = document.getElementById("submitBtn");
    const notification = document.getElementById("notification");

    // Initialisation au chargement de la page
    document.addEventListener("DOMContentLoaded", () => {
      // Initialiser les onglets de langue
      initLanguageTabs();
      
      // Initialiser les √©diteurs math√©matiques
      initMathFields();
      
      // Initialiser l'upload de fichier
      initFileUpload();
      
      // Initialiser la navigation
      setupNavigation();
    });

    // Gestion des onglets de langue
    function initLanguageTabs() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Retirer la classe active de tous les onglets
          tabs.forEach(t => t.classList.remove('active'));
          // Ajouter la classe active √† l'onglet cliqu√©
          tab.classList.add('active');
          
          // Masquer tous les contenus
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          
          // Afficher le contenu correspondant
          const tabId = tab.getAttribute('data-tab');
          document.getElementById(`${tabId}-content`).classList.add('active');
        });
      });
    }

    // Initialiser les champs math√©matiques
    function initMathFields() {
      const ids = [
        'question_fr', 'options_fr', 'reponse_fr', 'explication_fr',
        'question_en', 'options_en', 'reponse_en', 'explication_en'
      ];
      
      ids.forEach(id => {
        const mathField = document.getElementById(id + '_field');
        const textArea = document.getElementById(id);
        
        if (mathField && textArea) {
          mathField.value = textArea.value;
          
          // Synchroniser les modifications
          mathField.addEventListener('input', () => {
            textArea.value = mathField.value;
          });
        }
      });
    }

    // Initialiser l'upload de fichier avec aper√ßu
    function initFileUpload() {
      const fileInput = document.getElementById('image_exercice');
      const fileName = document.getElementById('file-name');
      const imagePreview = document.getElementById('imagePreview');
      const previewImage = document.getElementById('previewImage');
      const fileNameSpan = document.getElementById('fileName');
      
      fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          const file = this.files[0];
          fileName.textContent = file.name;
          fileNameSpan.textContent = file.name;
          
          // Afficher l'aper√ßu de l'image
          const reader = new FileReader();
          reader.onload = function(e) {
            previewImage.src = e.target.result;
            imagePreview.style.display = 'block';
          }
          reader.readAsDataURL(file);
        } else {
          fileName.textContent = langJs === 'en' ? 'Choose an image...' : 'Choisir une image...';
          imagePreview.style.display = 'none';
        }
      });
    }

    // Configuration de la navigation
    function setupNavigation() {
      const backLink = document.getElementById('backToDashboard');
      
      backLink.addEventListener('click', function(e) {
        e.preventDefault();
        goBackToDashboard();
      });
    }

    // Navigation vers le tableau de bord
    function goBackToDashboard() {
      const referrer = document.referrer;
      
      if (referrer && (referrer.includes('/admin/dashboard') || referrer.includes('/dashboard-enseignant'))) {
        window.location.href = referrer;
      } else {
        // Fallback intelligent
        if (window.location.pathname.includes('/admin/')) {
          window.location.href = '/admin/dashboard';
        } else {
          window.location.href = '/dashboard-enseignant';
        }
      }
    }

    // Ins√©rer du LaTeX dans un champ de texte
    function insererLatex(fieldId) {
      const textarea = document.getElementById(fieldId);
      const mathField = document.getElementById(fieldId + "_field");
      
      if (textarea && mathField && mathField.value.trim()) {
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const before = textarea.value.substring(0, start);
        const after = textarea.value.substring(end);
        const insertion = mathField.value.trim();
        
        textarea.value = before + insertion + after;
        textarea.selectionStart = textarea.selectionEnd = start + insertion.length;
        textarea.focus();
        
        // Afficher une notification
        showNotification(langJs === 'en' ? 'Formula inserted successfully!' : 'Formule ins√©r√©e avec succ√®s !', 'success');
      } else {
        showNotification(langJs === 'en' ? 'Please enter a formula first' : 'Veuillez d\'abord saisir une formule', 'error');
      }
    }

    // Afficher une notification
    function showNotification(message, type) {
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Gestion des changements de niveau
    niveau.addEventListener("change", async function () {
      matiere.innerHTML = ""; 
      unite.innerHTML = ""; 
      lecon.innerHTML = "";
      matiere.disabled = unite.disabled = lecon.disabled = true;

      if (!this.value) return;
      
      // Afficher un indicateur de chargement
      matiere.innerHTML = `<option value="">${langJs === 'en' ? 'Loading...' : 'Chargement...'}</option>`;
      
      try {
        const res = await fetch(`/api/matieres?niveau_id=${this.value}`);
        const matieres = await res.json();
        
        matiere.innerHTML = `<option value="">${langJs === 'en' ? '-- Choose subject --' : '-- Choisir une mati√®re --'}</option>`;
        matieres.forEach(m => {
          matiere.innerHTML += `<option value="${m.id}">${m.nom_en || m.nom}</option>`;
        });
        matiere.disabled = false;
      } catch (error) {
        console.error('Error loading subjects:', error);
        matiere.innerHTML = `<option value="">${langJs === 'en' ? 'Error loading subjects' : 'Erreur lors du chargement des mati√®res'}</option>`;
      }
    });

    // Gestion des changements de mati√®re
    matiere.addEventListener("change", async function () {
      unite.innerHTML = ""; 
      lecon.innerHTML = "";
      unite.disabled = lecon.disabled = true;

      if (!this.value) return;
      
      // Afficher un indicateur de chargement
      unite.innerHTML = `<option value="">${langJs === 'en' ? 'Loading...' : 'Chargement...'}</option>`;
      
      try {
        const res = await fetch(`/api/unites?matiere_id=${this.value}`);
        const unites = await res.json();
        
        unite.innerHTML = `<option value="">${langJs === 'en' ? '-- Choose unit --' : '-- Choisir une unit√© --'}</option>`;
        unites.forEach(u => {
          unite.innerHTML += `<option value="${u.id}">${u.nom_en || u.nom}</option>`;
        });
        unite.disabled = false;
      } catch (error) {
        console.error('Error loading units:', error);
        unite.innerHTML = `<option value="">${langJs === 'en' ? 'Error loading units' : 'Erreur lors du chargement des unit√©s'}</option>`;
      }
    });

    // Gestion des changements d'unit√©
    unite.addEventListener("change", async function () {
      lecon.innerHTML = "";
      lecon.disabled = true;

      if (!this.value) return;
      
      // Afficher un indicateur de chargement
      lecon.innerHTML = `<option value="">${langJs === 'en' ? 'Loading...' : 'Chargement...'}</option>`;
      
      try {
        const res = await fetch(`/api/lecons?unite_id=${this.value}&lang=${langJs}`);
        const lecons = await res.json();
        
        lecon.innerHTML = `<option value="">${langJs === 'en' ? '-- Choose lesson --' : '-- Choisir une le√ßon --'}</option>`;
        lecons.forEach(l => {
          lecon.innerHTML += `<option value="${l.id}">${l.titre}</option>`;
        });
        lecon.disabled = false;
      } catch (error) {
        console.error('Error loading lessons:', error);
        lecon.innerHTML = `<option value="">${langJs === 'en' ? 'Error loading lessons' : 'Erreur lors du chargement des le√ßons'}</option>`;
      }
    });

    // Gestion de la soumission du formulaire
    document.getElementById('exerciseForm').addEventListener('submit', function(e) {
      // Validation basique
      const requiredFields = this.querySelectorAll('[required]');
      let isValid = true;
      
      requiredFields.forEach(field => {
        if (!field.value.trim()) {
          isValid = false;
          field.style.borderColor = '#e74c3c';
        } else {
          field.style.borderColor = '';
        }
      });
      
      if (!isValid) {
        e.preventDefault();
        showNotification(
          langJs === 'en' ? 'Please fill in all required fields' : 'Veuillez remplir tous les champs obligatoires', 
          'error'
        );
        return;
      }
      
      // Afficher un indicateur de chargement
      submitBtn.innerHTML = `<span class="loading"></span> ${langJs === 'en' ? 'Adding...' : 'Ajout en cours...'}`;
      submitBtn.disabled = true;
    });
  </script>
</body>
</html>