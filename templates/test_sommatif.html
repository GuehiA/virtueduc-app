<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Favicon VirtuEduc -->
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon/favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon/favicon-16x16.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='favicon/site.webmanifest') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon/favicon.ico') }}">
  <meta name="msapplication-TileColor" content="#4361ee">
  <meta name="theme-color" content="#4361ee">
  <title>{% if lang == 'fr' %}√âvaluation Sommatif{% else %}Final Test{% endif %}</title>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- ‚úÖ MathJax avec configuration robuste et gestion d'erreurs -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true,
        tags: 'ams'
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
        ignoreHtmlClass: 'no-mathjax',
        renderActions: {
          find_script: [10, function (doc) {
            for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
              const text = node.textContent.replace(/%.*/g, '');
              if (node.type === 'math/tex; mode=display') {
                node.outerHTML = `\\[${text}\\]`;
              } else {
                node.outerHTML = `\\(${text}\\)`;
              }
            }
          }, '']
        }
      },
      startup: {
        pageReady: () => {
          return MathJax.startup.defaultPageReady().then(() => {
            console.log('MathJax configuration loaded successfully');
          }).catch((error) => {
            console.error('MathJax initialization error:', error);
            // Fallback: show raw content if MathJax fails
            document.querySelectorAll('.math-fallback').forEach(el => {
              el.style.display = 'block';
            });
          });
        }
      },
      loader: {
        load: ['[tex]/ams']
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script" defer></script>

  <style>
    :root {
      --primary: #3498db;
      --primary-dark: #2980b9;
      --secondary: #2c3e50;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --border-radius: 12px;
      --box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
      color: var(--dark);
      line-height: 1.6;
    }

    .container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 40px;
      max-width: 900px;
      margin: 0 auto;
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--success));
    }

    h2 {
      color: var(--secondary);
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    h2 i {
      color: var(--primary);
      font-size: 2.5rem;
    }

    .flash {
      padding: 15px 20px;
      border-radius: var(--border-radius);
      margin-bottom: 25px;
      font-weight: 600;
      text-align: center;
      animation: slideIn 0.5s ease;
    }

    .flash.success {
      background: linear-gradient(135deg, var(--success), #219150);
      color: white;
      box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
    }

    .flash.error {
      background: linear-gradient(135deg, var(--danger), #c0392b);
      color: white;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }

    .document-section {
      background: var(--light);
      border-radius: var(--border-radius);
      padding: 25px;
      margin-bottom: 30px;
      border-left: 4px solid var(--primary);
    }

    .document-section h4 {
      color: var(--secondary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem;
    }

    .iframe-wrapper {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }

    .iframe-wrapper iframe {
      width: 100%;
      height: 500px;
      border: none;
      pointer-events: none;
    }

    .iframe-wrapper .overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 2;
    }

    .exercices-container {
      margin: 35px 0;
    }

    .exercice-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      border: 1px solid #e9ecef;
      transition: var(--transition);
    }

    .exercice-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }

    .exercice-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
      color: var(--secondary);
    }

    .exercice-number {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .exercice-question {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--secondary);
      line-height: 1.6;
    }

    /* Styles pour l'affichage des symboles math√©matiques Unicode */
    .math-symbols {
      font-family: 'Segoe UI Symbol', 'Apple Symbols', 'Symbol', 'Arial Unicode MS', sans-serif;
    }

    .math-fallback {
      display: none;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      margin: 5px 0;
    }

    .exercice-image {
      text-align: center;
      margin: 20px 0;
    }

    .exercice-image img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid #e9ecef;
    }

    .response-section {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: var(--border-radius);
      padding: 30px;
      margin: 30px 0;
      text-align: center;
    }

    .response-section.success {
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(33, 145, 80, 0.05));
      border: 1px solid rgba(39, 174, 96, 0.2);
    }

    .response-icon {
      font-size: 3rem;
      color: var(--success);
      margin-bottom: 15px;
    }

    .info-text {
      color: var(--gray);
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    .date {
      background: white;
      padding: 8px 16px;
      border-radius: 20px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--gray);
      font-size: 0.9rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* √âditeur math√©matique simplifi√© */
    .unified-math-editor {
      background: var(--light);
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 25px;
      border: 2px solid #e9ecef;
    }

    .math-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .math-btn {
      padding: 10px 15px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.1em;
      font-weight: 600;
    }

    .math-btn:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
    }

    .visual-editor {
      min-height: 200px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      background: white;
      line-height: 1.6;
      font-size: 1.1rem;
      font-family: inherit;
    }

    .visual-editor:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .help-text {
      color: #6c757d;
      font-size: 0.9em;
      margin-top: 15px;
      line-height: 1.4;
    }

    .current-content {
      background: white;
      border: 2px solid var(--secondary);
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      font-size: 1rem;
      line-height: 1.5;
      min-height: 60px;
      flex-grow: 1;
    }

    .current-content:empty::before {
      content: "{{ 'Votre r√©ponse appara√Ætra ici...' if lang == 'fr' else 'Your answer will appear here...' }}";
      color: var(--gray);
      font-style: italic;
    }

    .current-content.has-content {
      border-color: var(--primary);
      background: #f8fff9;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: var(--transition);
      border: none;
      cursor: pointer;
      font-size: 1rem;
    }

    .btn-submit {
      background: linear-gradient(135deg, var(--success), #219150);
      color: white;
      padding: 15px 30px;
      font-size: 1.1rem;
      margin-top: 20px;
      width: 100%;
      justify-content: center;
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
    }

    .btn-back {
      background: linear-gradient(135deg, var(--secondary), #1a252f);
      color: white;
      margin-top: 20px;
    }

    .btn-back:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(44, 62, 80, 0.3);
    }

    /* Styles pour le rendu MathJax */
    .math-content mjx-container {
      display: inline-block;
      margin: 0 2px;
    }

    .math-display {
      text-align: center;
      margin: 15px 0;
      padding: 10px;
    }

    .math-inline {
      display: inline;
    }

    /* Overlay d'attente identique aux autres templates */
    .waiting-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .waiting-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .waiting-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      transform: translateY(20px);
      animation: slideUp 0.5s ease forwards;
    }

    .teacher-avatar {
      width: 120px;
      height: 120px;
      margin: 0 auto 20px;
      position: relative;
    }

    .teacher-image {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 3rem;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .thinking-animation {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 40px;
      height: 40px;
      background: var(--warning);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      animation: pulse 2s infinite;
    }

    .waiting-title {
      font-size: 1.8rem;
      color: var(--dark);
      margin-bottom: 15px;
      font-weight: 700;
    }

    .waiting-message {
      font-size: 1.1rem;
      color: var(--gray);
      margin-bottom: 25px;
      line-height: 1.6;
    }

    .loading-dots {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 20px 0;
    }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
      animation: bounce 1.4s infinite ease-in-out;
    }

    .dot:nth-child(1) { animation-delay: -0.32s; }
    .dot:nth-child(2) { animation-delay: -0.16s; }

    .processing-steps {
      text-align: left;
      margin: 25px 0;
      padding: 20px;
      background: var(--light);
      border-radius: 10px;
    }

    .processing-step {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .processing-step.active {
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .step-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--light);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      color: var(--gray);
      font-size: 0.9rem;
    }

    .processing-step.active .step-icon {
      background: var(--primary);
      color: white;
    }

    .step-text {
      flex: 1;
      color: var(--gray);
    }

    .processing-step.active .step-text {
      color: var(--dark);
      font-weight: 600;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    @keyframes bounce {
      0%, 80%, 100% {
        transform: scale(0);
      }
      40% {
        transform: scale(1);
      }
    }

    .exercice-card {
      animation: fadeIn 0.6s ease;
    }

    .exercice-card:nth-child(even) {
      animation-delay: 0.1s;
    }

    .exercice-card:nth-child(odd) {
      animation-delay: 0.2s;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        padding: 20px 10px;
      }

      .container {
        padding: 25px 20px;
      }

      h2 {
        font-size: 1.8rem;
        flex-direction: column;
        gap: 10px;
      }

      .document-section {
        padding: 20px;
      }

      .exercice-card {
        padding: 20px;
      }

      .iframe-wrapper iframe {
        height: 400px;
      }

      .waiting-card {
        padding: 30px 20px;
        margin: 20px;
      }

      .teacher-avatar {
        width: 100px;
        height: 100px;
      }

      .teacher-image {
        font-size: 2.5rem;
      }

      .math-toolbar {
        justify-content: center;
      }

      .math-btn {
        padding: 8px 12px;
        font-size: 1em;
      }
    }

    @media (max-width: 480px) {
      h2 {
        font-size: 1.5rem;
      }

      .exercice-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .iframe-wrapper iframe {
        height: 300px;
      }
    }
  </style>
</head>
<body oncontextmenu="return false;">

  <!-- Overlay d'attente identique aux autres templates -->
  <div class="waiting-overlay" id="waitingOverlay">
    <div class="waiting-card">
      <div class="teacher-avatar">
        <div class="teacher-image">
          <i class="fas fa-robot"></i>
        </div>
        <div class="thinking-animation">
          <i class="fas fa-brain"></i>
        </div>
      </div>
      
      <h2 class="waiting-title">
        <i class="fas fa-hourglass-half"></i>
        {% if lang == 'fr' %}
          Enseignant Virtuel en train de r√©fl√©chir...
        {% else %}
          Virtual Teacher is thinking...
        {% endif %}
      </h2>
      
      <p class="waiting-message">
        {% if lang == 'fr' %}
          Notre enseignant virtuel analyse votre r√©ponse et pr√©pare une √©valuation personnalis√©e.
        {% else %}
          Our virtual teacher is analyzing your answer and preparing personalized evaluation.
        {% endif %}
      </p>

      <div class="loading-dots">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>

      <div class="processing-steps">
        <div class="processing-step active" id="step1">
          <div class="step-icon">1</div>
          <div class="step-text">
            {% if lang == 'fr' %}
              Analyse de votre r√©ponse...
            {% else %}
              Analyzing your answer...
            {% endif %}
          </div>
        </div>
        <div class="processing-step" id="step2">
          <div class="step-icon">2</div>
          <div class="step-text">
            {% if lang == 'fr' %}
              √âvaluation des comp√©tences...
            {% else %}
              Evaluating skills...
            {% endif %}
          </div>
        </div>
        <div class="processing-step" id="step3">
          <div class="step-icon">3</div>
          <div class="step-text">
            {% if lang == 'fr' %}
              Pr√©paration du feedback...
            {% else %}
              Preparing feedback...
            {% endif %}
          </div>
        </div>
      </div>

      <div style="margin-top: 20px; font-size: 0.9rem; color: var(--gray);">
        <i class="fas fa-clock"></i>
        {% if lang == 'fr' %}
          Cela peut prendre quelques secondes...
        {% else %}
          This may take a few seconds...
        {% endif %}
      </div>
    </div>
  </div>

<div class="container">
  <h2>
    <i class="fas fa-file-alt"></i>
    {% if lang == 'fr' %}Test Sommatif{% else %}Final Test{% endif %}
  </h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash {{ category }}">
          <i class="fas fa-{% if category == 'success' %}check-circle{% else %}exclamation-triangle{% endif %}"></i>
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Section Documents -->
  {% if test.chemin_fichier %}
    <div class="document-section">
      <h4><i class="fas fa-file-pdf"></i> {% if lang == 'fr' %}Document associ√©{% else %}Attached document{% endif %}</h4>
      <div class="iframe-wrapper">
        <iframe src="{{ url_for('static', filename=test.chemin_fichier) }}"></iframe>
        <div class="overlay"></div>
      </div>
    </div>
  {% endif %}

  {% if test.chemin_corrige %}
    <div class="document-section">
      <h4><i class="fas fa-check-circle"></i> {% if lang == 'fr' %}Corrig√© disponible{% else %}Correction available{% endif %}</h4>
      <div class="iframe-wrapper">
        <iframe src="{{ url_for('static', filename=test.chemin_corrige) }}"></iframe>
        <div class="overlay"></div>
      </div>
    </div>
  {% endif %}

  <!-- Section Exercices -->
  <div class="exercices-container">
    {% for ex in test.exercices %}
      <div class="exercice-card">
        <div class="exercice-header">
          <div class="exercice-number">{{ loop.index }}</div>
          <div class="exercice-question math-content math-symbols" id="question-{{ loop.index }}">
            <!-- Version avec filtre replace_latex pour l'affichage garanti -->
            <div class="math-fallback">
              {{ (ex.question_fr if lang == 'fr' else ex.question_en) | replace_latex | safe }}
            </div>
            <!-- Version originale pour MathJax -->
            <div class="math-original" style="display: none;">
              {{ ex.question_fr if lang == 'fr' else ex.question_en }}
            </div>
          </div>
        </div>
        {% if ex.image_path %}
          <div class="exercice-image">
            <img src="{{ url_for('static', filename=ex.image_path) }}" alt="illustration">
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <!-- Section R√©ponse -->
  {% if reponse %}
    <div class="response-section success">
      <div class="response-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <p class="info-text">
        {% if lang == 'fr' %}Tu as d√©j√† soumis ce test.{% else %}You already submitted this test.{% endif %}
      </p>
      <a href="/historique?username={{ eleve.username }}&lang={{ lang }}" class="btn btn-back">
        <i class="fas fa-chart-line"></i>
        {% if lang == 'fr' %}Voir ton analyse dans l'historique{% else %}See your feedback in history{% endif %}
      </a>
      {% if reponse.timestamp %}
        <div class="date" data-date="{{ reponse.timestamp.isoformat() }}">
          <i class="fas fa-clock"></i>
          <span class="date-text">...</span>
        </div>
      {% endif %}
    </div>
  {% else %}
    <!-- Formulaire de r√©ponse avec √©diteur simplifi√© -->
    <form method="POST" id="testForm">
      <input type="hidden" name="reponse_eleve" id="reponse_eleve_hidden" value="">

      <!-- √âditeur math√©matique simplifi√© -->
      <div class="unified-math-editor">
        <div class="current-content" id="currentContent">
          {{ 'Votre r√©ponse appara√Ætra ici...' if lang == 'fr' else 'Your answer will appear here...' }}
        </div>

        <!-- Barre d'outils math√©matiques -->
        <div class="math-toolbar">
          <!-- Symboles math√©matiques de base -->
          <button type="button" class="math-btn" onclick="insertSymbol('¬≤')">x¬≤</button>
          <button type="button" class="math-btn" onclick="insertSymbol('¬≥')">x¬≥</button>
          <button type="button" class="math-btn" onclick="insertSymbol('‚àö')">‚àö</button>
          <button type="button" class="math-btn" onclick="insertSymbol('œÄ')">œÄ</button>
          <button type="button" class="math-btn" onclick="insertSymbol('‚àû')">‚àû</button>
          
          <!-- Op√©rateurs -->
          <button type="button" class="math-btn" onclick="insertSymbol('‚â†')">‚â†</button>
          <button type="button" class="math-btn" onclick="insertSymbol('‚âà')">‚âà</button>
          <button type="button" class="math-btn" onclick="insertSymbol('‚â§')">‚â§</button>
          <button type="button" class="math-btn" onclick="insertSymbol('‚â•')">‚â•</button>
          
          <!-- Fractions et lettres grecques -->
          <button type="button" class="math-btn" onclick="insertFraction()">¬Ω</button>
          <button type="button" class="math-btn" onclick="insertSymbol('Œ±')">Œ±</button>
          <button type="button" class="math-btn" onclick="insertSymbol('Œ≤')">Œ≤</button>
          <button type="button" class="math-btn" onclick="insertSymbol('Œ∏')">Œ∏</button>
          <button type="button" class="math-btn" onclick="insertSymbol('¬∞')">¬∞</button>
        </div>

        <!-- √âditeur visuel -->
        <div 
          class="visual-editor" 
          contenteditable="true"
          id="visualMathEditor"
          placeholder="{{ '√âcrivez votre r√©ponse compl√®te ici... Utilisez les boutons pour les symboles math√©matiques.' if lang == 'fr' else 'Write your complete answer here... Use the buttons for math symbols.' }}"
        ></div>

        <div class="help-text">
          üí° <strong>{{ 'Conseil :' if lang == 'fr' else 'Tip:' }}</strong> 
          {{ '√âcrivez normalement et utilisez les boutons pour les symboles math√©matiques. Votre r√©ponse s\'affiche automatiquement ci-dessus.' if lang == 'fr' else 'Write normally and use the buttons for math symbols. Your answer appears automatically above.' }}
        </div>
      </div>

      <button type="submit" class="btn btn-submit" id="submitBtn">
        <i class="fas fa-paper-plane"></i>
        {% if lang == 'fr' %}Soumettre ma r√©ponse{% else %}Submit my answer{% endif %}
      </button>
    </form>
  {% endif %}

  <!-- Navigation -->
  <div class="navigation">
    <a href="/dashboard-eleve?username={{ eleve.username }}&lang={{ lang }}" class="btn btn-back">
      <i class="fas fa-arrow-left"></i>
      {% if lang == 'fr' %}Retour au tableau de bord{% else %}Back to dashboard{% endif %}
    </a>
  </div>
</div>

<script>
  // Variables globales pour l'√©diteur
  let currentAnswer = '';

  // Fonctions pour l'√©diteur simplifi√©
  function insertSymbol(symbol) {
    const editor = document.getElementById('visualMathEditor');
    const selection = window.getSelection();
    
    if (selection.rangeCount > 0) {
      const range = selection.getRangeAt(0);
      range.deleteContents();
      range.insertNode(document.createTextNode(symbol));
    } else {
      // Ajouter √† la fin
      editor.focus();
      document.execCommand('insertText', false, symbol);
    }
    
    // Mettre √† jour l'aper√ßu automatiquement
    updatePreview();
  }

  function insertFraction() {
    const numerator = prompt('{{ "Num√©rateur :" if lang == "fr" else "Numerator:" }}', '1');
    const denominator = prompt('{{ "D√©nominateur :" if lang == "fr" else "Denominator:" }}', '2');
    
    if (numerator && denominator) {
      insertSymbol(`${numerator}‚àï${denominator}`);
    }
  }

  function updatePreview() {
    const content = document.getElementById('visualMathEditor').innerHTML
      .replace(/<div>/g, '\n')
      .replace(/<\/div>/g, '')
      .replace(/<br>/g, '\n')
      .replace(/&nbsp;/g, ' ')
      .replace(/<[^>]*>/g, '');
    
    document.getElementById('currentContent').textContent = content || '{{ "Votre r√©ponse appara√Ætra ici..." if lang == "fr" else "Your answer will appear here..." }}';
    
    // Mettre √† jour le style
    const currentContent = document.getElementById('currentContent');
    if (content.trim()) {
      currentContent.classList.add('has-content');
    } else {
      currentContent.classList.remove('has-content');
    }
    
    // Mettre √† jour le champ cach√©
    currentAnswer = content;
    document.getElementById('reponse_eleve_hidden').value = content;
  }

  // Gestion de la soumission du formulaire avec animation identique
  function setupFormSubmission() {
    const form = document.getElementById('testForm');
    const submitBtn = document.getElementById('submitBtn');
    const waitingOverlay = document.getElementById('waitingOverlay');

    if (form && submitBtn && waitingOverlay) {
      form.addEventListener('submit', function(e) {
        // Mettre √† jour automatiquement la r√©ponse avant soumission
        updatePreview();
        
        // V√©rifier qu'une r√©ponse a √©t√© saisie
        if (!currentAnswer.trim()) {
          e.preventDefault();
          alert('{{ "Veuillez √©crire votre r√©ponse avant de soumettre !" if lang == "fr" else "Please write your answer before submitting!" }}');
          return;
        }

        // Emp√™cher la soumission normale
        e.preventDefault();
        
        // Afficher l'overlay d'attente
        waitingOverlay.classList.add('active');
        
        // D√©sactiver le bouton de soumission
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {{ "Soumission en cours..." if lang == "fr" else "Submitting..." }}';
        
        // Animation des √©tapes de traitement
        let currentStep = 1;
        const stepInterval = setInterval(() => {
          document.getElementById('step' + currentStep).classList.remove('active');
          currentStep++;
          if (currentStep <= 3) {
            document.getElementById('step' + currentStep).classList.add('active');
          } else {
            clearInterval(stepInterval);
          }
        }, 1500);
        
        // Soumettre le formulaire apr√®s un court d√©lai pour l'effet visuel
        setTimeout(() => {
          form.submit();
        }, 2000);
      });
    }
  }

  // Gestion du contenu math√©matique
  function setupMathContent() {
    // Si MathJax est disponible, on l'utilise pour le rendu
    if (window.MathJax) {
      MathJax.startup.promise.then(() => {
        console.log('MathJax loaded successfully, using MathJax rendering');
        // Cacher la version fallback, afficher la version MathJax
        document.querySelectorAll('.math-fallback').forEach(el => {
          el.style.display = 'none';
        });
        document.querySelectorAll('.math-original').forEach(el => {
          el.style.display = 'block';
          el.classList.add('math-content');
        });
        
        // Traiter le contenu avec MathJax
        return MathJax.typesetPromise();
      }).catch(error => {
        console.warn('MathJax failed, using fallback rendering:', error);
        showFallbackMath();
      });
    } else {
      console.log('MathJax not available, using fallback rendering');
      showFallbackMath();
    }
  }

  function showFallbackMath() {
    // Afficher la version fallback avec les symboles Unicode
    document.querySelectorAll('.math-fallback').forEach(el => {
      el.style.display = 'block';
    });
    document.querySelectorAll('.math-original').forEach(el => {
      el.style.display = 'none';
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    console.log('DOM loaded, setting up math content...');
    
    // Configurer le contenu math√©matique
    setupMathContent();
    
    // Gestion des dates
    const dateEl = document.querySelector(".date");
    const lang = "{{ lang }}";
    
    if (dateEl) {
      const utc = dateEl.getAttribute("data-date");
      if (utc) {
        const local = new Date(utc);
        const dateText = dateEl.querySelector('.date-text');
        dateText.textContent = local.toLocaleString(lang === "fr" ? 'fr-FR' : 'en-GB');
      }
    }

    // Animation d'apparition progressive
    const cards = document.querySelectorAll('.exercice-card');
    cards.forEach((card, index) => {
      card.style.animationDelay = `${index * 0.1}s`;
    });

    // Configurer la soumission du formulaire
    setupFormSubmission();

    // Mise √† jour en temps r√©el de l'√©diteur visuel
    const visualEditor = document.getElementById('visualMathEditor');
    if (visualEditor) {
      visualEditor.addEventListener('input', updatePreview);
      
      // Focus sur l'√©diteur
      setTimeout(() => {
        visualEditor.focus();
      }, 500);
    }
  });
</script>
</body>
</html>